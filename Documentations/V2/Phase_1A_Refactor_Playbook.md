# Phase 1A Refactor Playbook

**Purpose**: Step-by-step guide to refactor one controller from unscoped `$request->all()` + `fill()` to Phase 1A-compliant scoped input with array-to-scalar normalization.

**Example Controller**: `IESEducationBackgroundController`

**Prerequisites**: Phase 0 complete; `ArrayToScalarNormalizer::forFillable()` exists.

---

# 1. BEFORE STATE (Anti-pattern)

Simplified `store()` method — current risky pattern:

```php
public function store(FormRequest $request, $projectId)
{
    $validated = $request->all();   // ← RISKY: pulls in ALL form data (phases, budget, files, etc.)

    DB::beginTransaction();
    try {
        $educationBackground = ProjectIESEducationBackground::where('project_id', $projectId)
            ->first() ?: new ProjectIESEducationBackground();
        $educationBackground->project_id = $projectId;
        $educationBackground->fill($validated);   // ← RISKY: arrays (e.g. family_contribution[]) cause "Array to string conversion"
        $educationBackground->save();
        // ...
    }
}
```

**Risky lines**:
- `$request->all()` — includes unrelated fields from multi-step form (e.g. `family_contribution[]` from IGE budget, file uploads).
- `$educationBackground->fill($validated)` — passes arrays into string columns; no ownership of which keys belong to this controller.

---

# 2. AFTER STATE (Phase 1A-compliant)

```php
use App\Support\Normalization\ArrayToScalarNormalizer;

public function store(FormRequest $request, $projectId)
{
    $model = new ProjectIESEducationBackground();
    $fillable = array_diff($model->getFillable(), ['project_id', 'IES_education_id']);

    $data = $request->only($fillable);
    $data = ArrayToScalarNormalizer::forFillable($data, $fillable);

    DB::beginTransaction();
    try {
        Log::info('Storing IES educational background', ['project_id' => $projectId]);

        $educationBackground = ProjectIESEducationBackground::where('project_id', $projectId)
            ->first() ?: new ProjectIESEducationBackground();
        $educationBackground->project_id = $projectId;
        $educationBackground->fill($data);
        $educationBackground->save();

        DB::commit();
        Log::info('IES educational background saved successfully', ['project_id' => $projectId]);
        return response()->json(['message' => 'IES educational background saved successfully.'], 200);
    } catch (\Exception $e) {
        DB::rollBack();
        Log::error('Error saving IES educational background', ['error' => $e->getMessage()]);
        return response()->json(['error' => 'Failed to save IES educational background.'], 500);
    }
}
```

**What changed**:
- Scoped input: `$request->only($fillable)` — only keys this controller owns.
- Excluded keys: `project_id`, `IES_education_id` — set by controller or model, not from request.
- Array-to-scalar: `ArrayToScalarNormalizer::forFillable()` — prevents arrays from reaching `fill()`.
- Clear separation: request handling (lines 1–6) vs persistence (transaction block).

---

# 3. STEP-BY-STEP REFACTOR PROCESS

## Step 1: Identify Fillable Keys

- **What**: List keys the controller should accept from the request.
- **How**: Use `$model->getFillable()` and exclude keys that are:
  - Set by the controller (e.g. `project_id`)
  - Auto-generated by the model (e.g. `IES_education_id`, `created_at`, `updated_at`)
- **Example**: `$fillable = array_diff((new ProjectIESEducationBackground())->getFillable(), ['project_id', 'IES_education_id']);`
- **Why safe**: Model's `$fillable` is the source of truth; we only scope further.
- **Do NOT**: Add keys not in `$fillable`; remove keys that the form actually sends.

---

## Step 2: Replace `$request->all()` with `$request->only($fillable)`

- **What**: Change `$validated = $request->all()` to `$data = $request->only($fillable)`.
- **Why safe**: Reduces payload to owned keys only; unrelated form sections no longer pollute.
- **Do NOT**: Use `$request->input($key)` per field unless you have a reason (e.g. nested keys). `only()` is sufficient and cleaner.

---

## Step 3: Apply ArrayToScalarNormalizer

- **What**: Add `$data = ArrayToScalarNormalizer::forFillable($data, $fillable);` after `only()`.
- **Why safe**: Coerces any array values (e.g. from `family_contribution[]`) to scalar; prevents "Array to string conversion".
- **Do NOT**: Skip this if the form is part of a multi-step submit; other sections can send arrays with overlapping names.

---

## Step 4: Use `$data` in `fill()`, Not `$validated`

- **What**: Change `$model->fill($validated)` to `$model->fill($data)`.
- **Why safe**: Ensures only normalized, scoped data reaches the model.
- **Do NOT**: Pass `$request` to `fill()` or use `$request->all()` anywhere after Step 2.

---

## Step 5: Keep Transaction, Logging, and Response Unchanged

- **What**: Leave DB transaction, try/catch, Log calls, and JSON response as-is.
- **Why safe**: No behavior change; only input handling changes.
- **Do NOT**: Add new validation rules, change error messages, or refactor `show`/`edit`/`destroy` in this pass.

---

# 4. COMMON PITFALLS

## Pitfall 1: Accidentally Dropping Fields

- **Mistake**: Excluding a key from `$fillable` that the form actually sends (e.g. `family_contribution`).
- **Symptom**: Field saves as null even when user entered data.
- **Prevention**: Compare `$fillable` to the form's `name` attributes. For IES Education Background: `previous_class`, `amount_sanctioned`, `amount_utilized`, `scholarship_previous_year`, `academic_performance`, `present_class`, `expected_scholarship`, `family_contribution`, `reason_no_support`.
- **Fix**: Add missing key to model's `$fillable` (if appropriate) or to the `$fillable` diff. Do not add keys that are not form inputs.

---

## Pitfall 2: Excluding Too Much from `getFillable()`

- **Mistake**: `$fillable = array_diff(getFillable(), ['project_id', 'IES_education_id', 'created_at', 'updated_at'])` — but `created_at`/`updated_at` are usually not in `$fillable` anyway.
- **Symptom**: None if model doesn't have them in fillable.
- **Prevention**: Only exclude keys that are in `getFillable()` and that you deliberately do not want from the request. Typical excludes: `project_id`, any auto-generated ID.

---

## Pitfall 3: Normalizing Too Aggressively

- **Mistake**: Adding custom normalization (e.g. stripping HTML, coercing numbers) inside the controller beyond `ArrayToScalarNormalizer`.
- **Symptom**: Data loss or unexpected type changes.
- **Prevention**: Phase 1A is only about scoping and array→scalar. Other normalization belongs in FormRequest or Phase 2.
- **Fix**: Use only `ArrayToScalarNormalizer::forFillable()`. If PlaceholderNormalizer is needed (e.g. `-` → null), add that in a FormRequest `prepareForValidation()`, not in the controller.

---

## Pitfall 4: Mixing Phase 1B Concerns

- **Mistake**: Changing form field names (e.g. `family_contribution` → `ies_education[family_contribution]`) in the same PR as the controller refactor.
- **Symptom**: Controller receives null for prefixed keys; data appears lost.
- **Prevention**: Phase 1A assumes form structure is unchanged. Only change how the controller reads the request.
- **Fix**: Revert form changes; do namespacing in Phase 1B after controllers are refactored.

---

## Pitfall 5: Refactoring `update()` When It Delegates to `store()`

- **Mistake**: Changing both `store()` and `update()` separately when `update()` just calls `return $this->store($request, $projectId)`.
- **Symptom**: Duplicate logic; risk of only one path being refactored.
- **Prevention**: If `update()` delegates to `store()`, refactor only `store()`. The delegation is fine.
- **Fix**: Leave `update()` as-is; it will automatically use the refactored `store()`.

---

## Pitfall 6: Touching Attachments or Files

- **Mistake**: Trying to "fix" IES attachments or file handling in the same controller refactor.
- **Symptom**: Scope creep; attachment logic is in models, not this controller.
- **Prevention**: This controller does not handle files. IES attachments are in `ProjectIESAttachments` / `IESAttachmentsController`. Do not touch those in this playbook.

---

# 5. COMPLETION CHECKLIST (Must-pass)

## Code-level checks

- [ ] No `$request->all()` in `store()` or `update()` (or the method they delegate to).
- [ ] `$request->only($fillable)` or equivalent is used; `$fillable` excludes `project_id` and auto-generated keys.
- [ ] `ArrayToScalarNormalizer::forFillable($data, $fillable)` is called before `fill()`.
- [ ] `$model->fill()` receives only the normalized `$data` variable, not `$request`.
- [ ] No new validation rules, FormRequest changes, or form/route edits in this refactor.
- [ ] `show`, `edit`, `destroy` are unchanged (unless they had the same anti-pattern; then refactor separately).

---

## Behavioral checks

- [ ] Create new IES project (IOES) through full flow → Education Background saves with all fields populated.
- [ ] Edit existing IOES project → change Education Background fields → save → data persists.
- [ ] Submit with empty optional fields → no error; nulls stored where expected.
- [ ] Submit with very long text in `academic_performance` or `reason_no_support` → truncates or validates per DB column; no "Array to string conversion".

---

## Log-based verification

- [ ] After deploy: no `Error saving IES educational background {"error":"Array to string conversion"` in production log.
- [ ] `Storing IES educational background` and `IES educational background saved successfully` still appear for successful saves.
- [ ] No new 5xx or unexpected validation errors on project create/edit for IES type.

---

# 6. REFERENCE: Fillable Keys for IES Education Background

| Key | Source | Exclude from request? |
|-----|--------|----------------------|
| `project_id` | Set by controller | Yes |
| `IES_education_id` | Auto-generated in model | Yes |
| `previous_class` | Form | No |
| `amount_sanctioned` | Form | No |
| `amount_utilized` | Form | No |
| `scholarship_previous_year` | Form | No |
| `academic_performance` | Form | No |
| `present_class` | Form | No |
| `expected_scholarship` | Form | No |
| `family_contribution` | Form | No |
| `reason_no_support` | Form | No |

**Effective `$fillable` for request**: `previous_class`, `amount_sanctioned`, `amount_utilized`, `scholarship_previous_year`, `academic_performance`, `present_class`, `expected_scholarship`, `family_contribution`, `reason_no_support`.

---

*Playbook version: 1.0 — Phase 1A Input & Authority Hardening*
