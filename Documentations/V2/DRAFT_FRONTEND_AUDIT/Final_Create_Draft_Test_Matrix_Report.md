# Final Create Draft Test Matrix Report

**Objective:** Confirm structural and draft boundary correctness in Create flow (StoreProjectRequest + Controller).  
**Type:** Simulation / code-trace only. No code was modified.  
**Date:** 2026-02-10

---

## CASE 1 – Empty project_type

**Simulated payload:** project_type = null (or missing), all other business fields empty, save_as_draft = true.

### Flow trace

1. **Request** → `ProjectController::store(StoreProjectRequest $request)`.
2. **StoreProjectRequest** runs first (Laravel FormRequest pipeline): `authorize()` → `prepareForValidation()` → **validation**.
3. **Validation:** `project_type` rule is `required|string|max:255`. Empty/missing project_type **fails**.
4. **ValidationException** is thrown by the FormRequest layer **before** the controller method body runs.
5. **ProjectController::store()** body (including `DB::beginTransaction()` and `storeGeneralInfoAndMergeProjectId`) is **never executed**.
6. No transaction is started; GeneralInfoController::store() is never called; no `Project::create()`.

### Validation result

- **Fails.** Rule `project_type` => `required|string|max:255` fails when value is null or missing.

### Error messages

- Error bag contains validation error for `project_type`.
- Custom message from StoreProjectRequest::messages(): **"Project type is required."** (StoreProjectRequest line 87: `'project_type.required' => 'Project type is required.'`).
- User is redirected back with errors and input (Laravel default for ValidationException).

### DB write status

- **No DB write.** Controller is not entered; no transaction; no insert. **No partial record inserted.**

### SQL error status

- **No SQL error.** No database write is attempted. **No NOT NULL error** (failure is at validation, not at DB).

### Exception / lifecycle

- Only **ValidationException** is thrown (standard FormRequest validation failure). No uncaught exception stack; no lifecycle conflict. Controller catch for ValidationException would only run if validation had passed and something later threw—not the case here.

### Verdict

**PASS** — Empty project_type causes validation to fail with "Project type is required."; no DB write, no partial insert, no SQL error, no project_id generated. Structural rule enforced correctly.

---

## CASE 2 – Valid project_type only (everything else empty)

**Simulated payload:** project_type = valid existing type (e.g. a ProjectType constant), project_title = null, overall_project_budget = null, all other business fields empty, save_as_draft = true.

### Flow trace

1. **StoreProjectRequest:** project_type is present and valid; other fields nullable. **Validation passes.**
2. **ProjectController::store()** runs: `DB::beginTransaction()`, then `storeGeneralInfoAndMergeProjectId($request)` → `GeneralInfoController::store($request)`.
3. **GeneralInfoController::store():** `$validated = $request->validated();` (no second `validate()`—single source of truth). validated() contains project_type and null/missing for others.
4. **Defaults applied:** `user_id` = Auth::id(); `status` = DRAFT; `amount_forwarded` = 0.00; `local_contribution` = 0.00; `executor_*` from request or user; **in_charge** = `$validated['in_charge'] ?? Auth::id()`; **overall_project_budget** = `$validated['overall_project_budget'] ?? 0.00`.
5. **Project::create($validated)** runs with project_type set, in_charge and overall_project_budget defaulted; nullable columns (e.g. project_title, society_name) can be null. DB NOT NULL columns satisfied.
6. project_id is generated by the database/engine (e.g. UUID or auto-increment per schema).
7. Rest of store (institutional sections, key info, type-specific handlers) runs; `DB::commit()`; redirect.

### Validation result

- **Passes.** project_type required and provided; all other fields nullable.

### DB row snapshot (logical)

- **projects row created.** Columns include: project_type (from request), project_title (null), society_name (null), in_charge (Auth::id()), overall_project_budget (0.00), user_id, status = DRAFT, amount_forwarded = 0.00, local_contribution = 0.00, commencement_month_year (null), etc. Nullable columns may be null; NOT NULL columns have values from validated or defaults.

### project_id generated

- **Yes.** project_id is set by the application or DB when `Project::create($validated)` is called (e.g. model primary key generation).

### Status value

- **status = DRAFT.** Set in GeneralInfoController::store() (`$validated['status'] = ProjectStatus::DRAFT`) before create; also enforced in applyPostCommitStatusAndRedirect for create flow.

### SQL integrity

- **No NOT NULL violation.** project_type from request; in_charge and overall_project_budget from defaults. **No partial corrupt write**—single create with full row from $validated (plus mappings). Transaction commits only after full store path.

### Verdict

**PASS** — Valid project_type only: validation passes, project is created, status = DRAFT, project_id generated, no SQL errors, no NOT NULL violation, no partial corrupt write.

---

## CASE 3 – project_type selected + budget = 0

**Simulated payload:** project_type = valid, overall_project_budget = 0, all other business fields empty, save_as_draft = true.

### Flow trace

1. **StoreProjectRequest:** project_type required and provided; overall_project_budget = 0 passes `nullable|numeric|min:0`. **Validation passes.**
2. **GeneralInfoController::store():** `$validated = $request->validated();`. validated() contains project_type and **overall_project_budget = 0** (key present, value 0).
3. **Default line:** `$validated['overall_project_budget'] = $validated['overall_project_budget'] ?? 0.00;` — key is present (0), so **0 is preserved** (not replaced by 0.00; ?? only replaces when key missing or null; 0 is present).
4. **Project::create($validated)** writes overall_project_budget = 0 to DB. amount_forwarded and local_contribution default to 0.00; amount_forwarded custom rule uses `$this->input('overall_project_budget', 0)`—no conflict with 0.
5. status = DRAFT; project created; transaction committed.

### Validation result

- **Passes.** project_type and overall_project_budget (0) valid; others nullable.

### DB row snapshot (logical)

- **projects row created.** overall_project_budget column = **0** (stored as numeric 0, not null). project_type, in_charge, user_id, status, etc. as in CASE 2.

### Stored budget value

- **overall_project_budget = 0** in DB. Not converted to NULL; not overwritten by preservation logic (preservation is in UpdateProjectRequest, not used on Create). No calculation or JS in this path—value comes from request → validated() → create.

### Status value

- **status = DRAFT.**

### Calculation integrity

- **amount_forwarded** validation closure uses `$this->input('overall_project_budget', 0)`; with budget 0, no "exceeds overall budget" failure. **No NaN or JS error** in Create server path. Client-side budget JS (edit/scripts) not involved in create submit.

### Verdict

**PASS** — project_type + budget 0: validation passes, 0 stored correctly, not converted to NULL, no overwrite by preservation, no numeric/validation failure, status = DRAFT.

---

## Critical confirmations

| Check | Result |
|-------|--------|
| **No hidden partial inserts** | On validation failure (CASE 1), controller body does not run; no transaction, no create. On success (CASE 2, 3), single Project::create() with full $validated row; no split or partial insert. |
| **No exception stack beyond validation** | CASE 1: only ValidationException from FormRequest; no DB or server exception. CASE 2/3: normal path; any later exception would trigger rollBack and redirect (no silent partial commit). |
| **No lifecycle conflicts** | Create uses StoreProjectRequest only; UpdateProjectRequest (and its prepareForValidation preservation) does not run. Single validation pipeline; single create path. |
| **FormRequest validation single source of truth** | GeneralInfoController::store() uses `$request->validated()` only; no `$request->validate([...])` in store(). StoreProjectRequest is the only validator for create general info. |
| **No duplicate validation in controller** | GeneralInfoController::store() contains no inline validate() call; duplicate validation was removed in Batch 3. |

---

**End of report. No code was modified.**
